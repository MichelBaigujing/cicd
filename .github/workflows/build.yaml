name: Build and Push
on:
  push:
    branches:
      - release/v[0-9]+.[0-9]+

env:
  REPORT_FILE: trivy-report.txt
  SLACK_CHANNEL: test-submission
  NAME: Ji Jia
  MATRICULATION: A0291948L
  EMAIL: e1336512@u.nus.edu
  IMAGE_NAME: cicd

jobs:
  scan:
    name: Scan
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.head_commit.message, '#NORUN') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Scan vulnerability with Trivy
        id: scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          output: ${{ env.REPORT_FILE }}
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
      - name: Notify scan failure
        if: steps.scan.outcome == 'failure'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: ${{ env.SLACK_CHANNEL }}
          SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_FILE_UPLOAD: ${{ env.REPORT_FILE }}
          SLACK_TITLE: Scan failed - ${{ env.NAME }}
          SLACK_MESSAGE: Trivy scan failed, see uploaded report please

  build-and-sign:
    name: Build and sign
    runs-on: ubuntu-latest
    needs: scan
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        id: build-push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0
        with:
          cosign-release: 'v2.2.4'
      - name: Sign the image with cosign
        run: |
          cosign sign --key env://COSIGN_PRIVATE_KEY --yes ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      - name: Notify success
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL }}
          slack-message: "*Name:* ${{ env.NAME }}\n*Matriculation:* ${{env.MATRICULATION}}\n*Email:* ${{env.EMAIL}}\n*Git:* ${{ github.server_url }}/${{ github.repository }} \n*Image:* https://hub.docker.com/repository/docker/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

        
  
